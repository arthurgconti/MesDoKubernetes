---
- hosts: all
  tasks:
    - name: updating system
      apt:
        update_cache: yes
        upgrade: yes
        cache_valid_time: 86400
      become: true

    - name: disable swap in machine for kubernetes work
      block:
        - name: Disable SWAP since kubernetes can't work with swap enabled
          shell: |
            swapoff -a
      become: true

    - name: Loading kernel modules and setting up system
      block:
        - name: Appending modules overlay and br_netfilter
          shell: |
            cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
            overlay
            br_netfilter
            EOF
        - name: Enabling overlay
          shell: modprobe overlay
        - name: Enabling br_netfilter
          shell: modprobe br_netfilter
        - name: Setting up system parameters
          shell: |
            cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
            net.bridge.bridge-nf-call-iptables  = 1
            net.bridge.bridge-nf-call-ip6tables = 1
            net.ipv4.ip_forward                 = 1
            EOF
        - name: reloading system configs
          shell: sysctl --system
      become: true

    - name: Installing k8s tools and dependencies
      block:
        - name: Installing dependencies packages
          ansible.builtin.package:
            use: auto
            name:
              - apt-transport-https
              - curl
              - ca-certificates
              - gnupg
              - lsb-release
            state: latest
        - name: Getting  Google keys
          shell: curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        - name: Adding  Google keys
          shell: echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

        - name: Getting  Containerd keys
          shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        - name: Adding  containerd keys
          shell: echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

        - name: update packages
          apt:
            update_cache: yes
            upgrade: no
            cache_valid_time: 86400

        - name: Installing k8s tools and containerd
          apt:
            name: "{{ packages }}"
            state: latest
            update_cache: yes
          vars:
            packages:
              - kubelet
              - kubeadm
              - kubectl
              - containerd.io
      become: true

    - name: Configurating containerd
      block:
        - name: Exporting default config
          shell: sudo containerd config default | sudo tee /etc/containerd/config.toml
        - name: Editing default config
          shell: sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
        - name: restarting containerd
          ansible.builtin.service:
            name: containerd
            state: restarted
      become: true
